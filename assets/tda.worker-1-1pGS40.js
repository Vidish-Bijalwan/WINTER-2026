var v=Object.defineProperty;var I=(g,u,f)=>u in g?v(g,u,{enumerable:!0,configurable:!0,writable:!0,value:f}):g[u]=f;var T=(g,u,f)=>I(g,typeof u!="symbol"?u+"":u,f);(function(){"use strict";function g(d,n=6e4){const e=Date.now(),o=d.filter(s=>e-s.timestamp.getTime()<n),h=[],m=new Map;o.forEach(s=>{const i=s.timestamp.getTime(),c=m.get(s.user);c?(c.last=Math.max(c.last,i),c.first=Math.min(c.first,i),c.count++):m.set(s.user,{first:i,last:i,count:1})}),m.forEach((s,i)=>{if(s.count>=2){const c=(s.first-(e-n))/n,t=Math.min((s.last-(e-n))/n+.1,1);t>c&&h.push({id:`h0-${i}`,dimension:0,birth:Math.max(0,c),death:Math.min(1,t)})}});const r=new Map;o.forEach(s=>{r.has(s.title)||r.set(s.title,new Set),r.get(s.title).add(s.user)}),r.forEach((s,i)=>{if(s.size>1){const c=Math.random()*.3,t=c+.2+Math.random()*.5;h.push({id:`h1-${i}`,dimension:1,birth:c,death:Math.min(t,1)})}});const l=new Map;return o.forEach(s=>{l.set(s.wiki,(l.get(s.wiki)||0)+1)}),l.forEach((s,i)=>{s>10&&h.push({id:`h2-${i}`,dimension:2,birth:Math.random()*.2,death:.3+Math.random()*.6})}),h.slice(0,50)}function u(d,n){const e=d.birth-n.birth,o=d.death-n.death;return Math.sqrt(e*e+o*o)}function f(d){return Math.abs(d.birth-d.death)/Math.sqrt(2)}function x(d,n,e=1){const o=d.filter(t=>f(t)>.01),h=n.filter(t=>f(t)>.01),m=o.length,r=h.length;let l=0;const s=new Set,i=new Set,c=[];for(let t=0;t<m;t++)for(let a=0;a<r;a++)if(o[t].dimension===h[a].dimension){const M=u(o[t],h[a]);c.push({i:t,j:a,cost:Math.pow(M,e)})}c.sort((t,a)=>t.cost-a.cost);for(const t of c)if(!s.has(t.i)&&!i.has(t.j)){const a=Math.pow(f(o[t.i]),e),M=Math.pow(f(h[t.j]),e);t.cost<=a+M&&(l+=t.cost,s.add(t.i),i.add(t.j))}for(let t=0;t<m;t++)s.has(t)||(l+=Math.pow(f(o[t]),e));for(let t=0;t<r;t++)i.has(t)||(l+=Math.pow(f(h[t]),e));return Math.pow(l,1/e)}function S(d,n=3,e=100,o){const h=[...new Set(d.map(r=>r.dimension))],m=[];for(const r of h){const l=d.filter(a=>a.dimension===r&&a.death!==1/0);if(l.length===0)continue;let s=Math.min(...l.map(a=>a.birth)),i=Math.max(...l.map(a=>a.death));const c=(i-s)*.1;s-=c,i+=c;const t=(i-s)/e;for(let a=1;a<=n;a++){const M=[];for(let y=0;y<=e;y++){const p=s+y*t,w=l.map(E=>Math.max(0,Math.min(p-E.birth,E.death-p)));w.sort((E,N)=>N-E);const A=w[a-1]||0;M.push({t:p,y:A})}m.push({dimension:r,layerIndex:a,values:M})}}return m}function D(d,n=2){let e=0;for(const o of d.values)e+=Math.pow(Math.abs(o.y),n);return Math.pow(e,1/n)}class L{constructor(n=50){T(this,"baselineDiagrams",[]);T(this,"baselineLandscapes",[]);T(this,"windowSize",50);T(this,"threshold",3);this.windowSize=n}addToBaseline(n){this.baselineDiagrams.length>=this.windowSize&&(this.baselineDiagrams.shift(),this.baselineLandscapes.shift()),this.baselineDiagrams.push(n);const e=S(n,1,50),o=e.length>0?D(e[0]):0;this.baselineLandscapes.push(o)}detect(n,e){if(this.baselineDiagrams.length<5)return{totalScore:0,components:{wasserstein:0,landscape:0,statistical:0},isAnomaly:!1,confidence:0};const o=this.baselineDiagrams.slice(-5);let h=0;for(const p of o)h+=x(n,p);h/=o.length;const m=S(n,1,50),r=m.length>0?D(m[0]):0,l=this.baselineLandscapes.reduce((p,w)=>p+w,0)/this.baselineLandscapes.length,s=Math.sqrt(this.baselineLandscapes.map(p=>Math.pow(p-l,2)).reduce((p,w)=>p+w,0)/this.baselineLandscapes.length)||1,i=Math.abs((r-l)/s),c=e?Math.abs(e):0,t=h*10,a=t*.4+i*.4+c*.2,M=a>this.threshold,y=Math.min(1,Math.max(0,(a-this.threshold)/2+.5));return{totalScore:a,components:{wasserstein:t,landscape:i,statistical:c},isAnomaly:M,confidence:M?y:0}}}let b=null;self.onmessage=d=>{const{type:n,payload:e}=d.data;if(n==="INIT")b=new L(e.windowSize||50),self.postMessage({type:"INIT_COMPLETE"});else if(n==="ANALYZE"){b||(b=new L(50));const{events:o,windowMs:h}=e,m=performance.now();try{const r=g(o,h);Math.random()<.1&&b.addToBaseline(r);const l=o.length/(h/1e3),s=b.detect(r,l),i=performance.now();self.postMessage({type:"RESULT",payload:{score:s,diagram:r,processingTime:i-m}})}catch(r){console.error("TDA Worker Error:",r),self.postMessage({type:"ERROR",payload:{message:r.message}})}}}})();
